@model TikTokCalendar.DAL.ModelDataWrapper

@{
    TimeLeft TimeLeft = new TimeLeft();
    EventUserStatHandler EUSH = new EventUserStatHandler();

    // This can be retrieved from Model.user so we don't have to do even more business logic here
    TikTokCalendar.DAL.Cookies cookie = new TikTokCalendar.DAL.Cookies();
    string userName = "";
    userName = cookie.LoadStringFromCookie("UserName");
    if (userName == null)
    {
        userName = "";
    }

    // show from week number (show from top when searching)
    int anchor = 1;
    if (Model.searchWords == "")
    {
        anchor = TikTokCalendar.Extras.Utils.GetWeekNumberOfYear(DateTime.Now);
    }
}

<!-- Go to current month/week -->
<script>
$(function() {
	@*$(document).scrollTop( $("#goto-@DateTime.Now.Month").offset().top );*@
	$(document).scrollTop( $("#goto-week-@anchor").offset().top - 65 );
});
</script>

<!-- Holds global settings and spans the entire page   -->
<main>
    <div class="main-body">

        <!-- Looping throught every month -->
        @foreach (var month in Model.Months)
        {
            var isCollapsed = "in";
            if (month.MonthNumber < DateTime.Now.Month && Model.searchWords == "")
            {
                isCollapsed = ""; // true
            }
            <div class="goto" id="goto-@month.MonthNumber"></div>
            <!-- Month box e.g. "August" -->
            <a class="feed-month" data-toggle="collapse" data-target="#month-@month.MonthNumber">

				<span class="badge-container">
					<span class="badge badge-exam pull-right">@month.GetEventTypeCount(TikTokCalendar.Models.EventType.Eksamen)</span>
					<span class="badge badge-assignment pull-right">@month.GetEventTypeCount(TikTokCalendar.Models.EventType.Innlevering)</span>
					<span class="badge badge-lecture pull-right">@month.GetEventTypeCount(TikTokCalendar.Models.EventType.Forelesning)</span>
				</span>

                <p class="month">
					@month.GetMonthName()
				</p>
				
            </a>
            <!-- Container for an entire month of events -->
            <div class="feed collapse @isCollapsed" id="month-@month.MonthNumber">

                <!-- Looping throught every week -->
                @foreach (var week in month.Weeks)
                {

                    if (week.events.Count <= 0)
                    {
                        continue;
                    }

                    <!-- Week box e.g. "Uke 2" -->
                    <div class="week-header" id="goto-week-@week.WeekNumber">@week.WeekName</div>
                    <div class="feed-week">

                        <!-- Looping throught every events -->
                        @foreach (var item in week.events)
                        {
							var today = "";
							if (item.StartDateTime.Date.Equals(DateTime.Now.Date))
							{
								today = "today";
							}

                            <!-- Link on every event -->
                            <div class="feed-container @today">

                                <!-- Container for the event content -->
                                <div class="content">

                                    <!-- Container for the top row -->
                                    <div class="class-info event-id-@item.ID" data-toggle="modal" data-target="#@item.ID">
                                        <div class="class-date">
                                           
                                            <!-- 17 -->
                                            <p class="date-number">@item.StartDateTime.Day</p>  
                                        </div>

                                        <!-- tooltip hover extravaganza -->
                                        <div class="tip-item">

                                            <!-- "Grensesnittdesign" -->
                                            <p class="name activator timeleft">@item.Subject.Name</p>
                                            @{
                                                string timeLeft = TimeLeft.GetTimeLeft(item.StartDateTime);
                                                bool lessThanAnHour = false;
                                                bool lessThan24 = false;
                                            }
                                            @if (timeLeft != "") {
                                                if (item.StartDateTime > DateTime.Now.AddHours(24))
                                                {
                                                    <div class="tip timeleft">@timeLeft</div>
                                                }
                                                if (item.StartDateTime < DateTime.Now.AddHours(24))
                                                {
                                                    if (item.StartDateTime < DateTime.Now.AddHours(1))
                                                    {
                                                        lessThanAnHour = true;
                                                    }
                                                    else {
                                                        lessThan24 = true;
                                                    }
                                                }
                                            }
                                        </div>
                                        <div class="right-position">
                                            @{
												var typeClass = "";
												var typeText = item.EventTypeLabel;

												if (item.MainEventType == TikTokCalendar.Models.MainEventType.Innlevering) {
													typeClass = "assignment";
													//typeText = "Innlevering";
												}
												else if (item.MainEventType == TikTokCalendar.Models.MainEventType.Eksamen) {
													typeClass = "exam";
													//typeText = "Eksamen";
												}
                                            }

                                            <p class="@typeClass">@typeText</p> <!-- "Forelesning" -->
                                            <p class="room">@item.RoomName</p>  <!-- "Rom 41" -->
                                        </div>
                                    </div>

                                    <!-- Container for bottom row -->
                                    <div class="time-info">
                                        <div class="left-position" data-toggle="modal" data-target="#@item.ID">
                                            <!-- Date and time  -->
                                            <p class="time">
                                                <strong>&nbsp;@item.GetDayOfWeek()</strong>@item.GetTimeSlot()
                                                @if (DateTime.Now > item.StartDateTime && DateTime.Now < item.EndDateTime) {
                                                    <b>&nbsp;&nbsp;&nbsp;</b><span class="ongoing">Pågår</span>
												}
                                                else if (lessThanAnHour) {
												    
                                                    <!-- real time countdown script -->
                                                    <script>
                                                        $(function () {
                                                            var date = new Date();
                                                            date = new Date(@item.StartDateTime.Year , @item.StartDateTime.AddMonths(-1).Month , @item.StartDateTime.Day , @item.StartDateTime.Hour , @item.StartDateTime.Minute , @item.StartDateTime.Second );
                                                            $('.countdown-@item.ID').countdown({until: date, expiryUrl: ''+window.location.href, compact: true,
                                                                layout: '&nbsp;{hnn}{sep}{mnn}{sep}{snn}' });
                                                        });
                                                    </script>
                                                    <span>&nbsp;|</span>
                                                <span class="countdown-@item.ID"></span>
												}
                                                else if (lessThan24) {
                                                    <b>&nbsp;&nbsp;&nbsp;</b><span class="countdown">@timeLeft</span>
                                                }
                                            </p>
                                        </div>

                                        <!-- Icon displaying "..."  -->
                                        
										<!-- FLYTT GOING/ATTEND KODEBLOKK NED HIT NÅR EVENT-CLICK ER FIKSA -->
                                        <!-- eventually limit the number of weeks for going/check-in to show here:
                                        if (DateTime.Now > item.StartDateTime && DateTime.Now < item.EndDateTime.AddDays(21))
                                        {-->
                                        @if (userName != "" && userName != "Jon Doe" && item.MainEventType != TikTokCalendar.Models.MainEventType.Innlevering)
										{
											using (Ajax.BeginForm("UserStatUpdate", "Home", new { id = "check-in-form-" + @item.ID }, new AjaxOptions
											{
												HttpMethod = "POST",
												UpdateTargetId = "going-" + item.ID,
												InsertionMode = InsertionMode.Replace
											}))
											{
												// Everything in this div is replaced by content in _UserStatUpdate.cshtml on button press
                                        <div class="check-in" id="going-@item.ID">
                                            @if (DateTime.Now > item.StartDateTime && DateTime.Now < item.EndDateTime)
											{
												bool geo = true;
												if (!EUSH.UserAttending(item.ID, userName))
															{
													<input type="hidden" name="eventid" value="@item.ID" />
													<input type="hidden" name="attend" value="true" />

													if (geo)
													{
														<input type="submit" style="display:none;" value="Check-in" onload="(this).submit()" />
													}
													else {
														<input type="submit" value="Check-in" />
													}
												}
												else {
													<strong>Innsjekket &#10004;</strong>
												}

											}
											else {
												if (!EUSH.UserGoing(item.ID)) {
                                                    <input type="hidden" name="eventid" value="@item.ID" />
                                                    <input type="hidden" name="attend" value="false" />
                                                    <input type="submit" value="Going" class="going-@item.ID"/>
                                                }
                                                else
                                                {
                                                    <strong>going</strong>
                                                }
                                            }
                                            <div class="tip-item">
                                                @{
                                                    var howMany = EUSH.HowManyUsersGoing(item.ID);
                                                    var showTip = "hide";
                                                    if (howMany > 0)
                                                    {
                                                        showTip = ""; // false (hide box if no users to display)
                                                    }
                                                }
                                                <span class="activator usersgoing event-id-@item.ID">@howMany going</span>
                                                <div class="tip usersgoing @showTip">
                                                    @foreach (var eus in Model.eventUserStats)
                                                    {
                                                        if (eus.EventID == item.ID)
                                                        {
                                                            <span class="no-linebreak">
                                                                @if (EUSH.UserAttending(item.ID, eus.UserName))
                                                                {
                                                                    <text>&#10004;</text>
                                                                }
                                                                @eus.UserName<br />
                                                            </span>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                                        }
                                                    }
                                    </div>
                                </div>
                            </div>


                                <!-- "More info" modal -->
                                <div class="content-hidden modal fade" id="@item.ID" role="dialog">
                                    <div class="modal-dialog">
                                        <div class="modal-content">

                                            <!-- Modal header -->
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                @item.Subject.Name
                                            </div>

                                            <!-- Modal body -->
                                            <div class="modal-body">
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Tid</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.GetDayOfWeek()@item.GetTimeSlot()
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Uke</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @week.WeekNumber
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Rom</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.RoomName
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Lærer</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.Teacher
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Kommentar</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.Comment
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                }
					</div>
				}
			</div>
		}
    </div>
</main>

