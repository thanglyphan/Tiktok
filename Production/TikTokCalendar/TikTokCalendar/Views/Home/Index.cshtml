@model TikTokCalendar.DAL.ModelDataWrapper

@{
    TimeLeft TimeLeft = new TimeLeft();
    EventUserStatHandler EUSH = new EventUserStatHandler();

    // This can be retrieved from Model.user so we don't have to do even more business logic here
    TikTokCalendar.DAL.Cookies cookie = new TikTokCalendar.DAL.Cookies();
    string userName = "";
    userName = cookie.LoadStringFromCookie("UserName");
    if (userName == null) {
        userName = "";
    }

    // show from week number (show from top when searching)
    int anchor = 1;
    if (Model.searchWords == "") {
        anchor = TikTokCalendar.Extras.Utils.GetWeekNumberOfYear(DateTime.Now);
    }
}

<!-- Go to current month/week -->
<script>
	$(function() {
		@*$(document).scrollTop( $("#goto-@DateTime.Now.Month").offset().top );*@
		$(document).scrollTop( $("#goto-week-@anchor").offset().top - 56 );
	});

</script>

<!-- Holds global settings and spans the entire page   -->
<main>
    <div class="main-body">

        <!-- Looping throught every month -->
        @foreach (var month in Model.Months) {
            var isCollapsed = "in";
            if (month.MonthNumber < DateTime.Now.Month && !Model.isFiltered) {
                isCollapsed = ""; // true
            }
            <div class="goto" id="goto-@month.MonthNumber"></div>
            <!-- Month box e.g. "August" -->
            <a class="feed-month" data-toggle="collapse" data-target="#month-@month.MonthNumber">

				<span class="badge-container">
					<span class="badge badge-exam pull-right">@month.GetEventTypeCount(TikTokCalendar.Models.EventType.Eksamen)</span>
					<span class="badge badge-assignment pull-right">@month.GetEventTypeCount(TikTokCalendar.Models.EventType.Innlevering)</span>
					<span class="badge badge-lecture pull-right">@month.GetEventTypeCount(TikTokCalendar.Models.EventType.Forelesning)</span>
				</span>

                <p class="month">
					@month.GetMonthName()
				</p>
				
            </a>
            <!-- Container for an entire month of events -->
            <div class="feed collapse @isCollapsed" id="month-@month.MonthNumber">

                <!-- Looping throught every week -->
                @foreach (var week in month.Weeks) {

                    if (week.events.Count <= 0) {
                        continue;
                    }

                    <!-- Week box e.g. "Uke 2" -->
                    <div class="week-header" id="goto-week-@week.WeekNumber">@week.WeekName</div>
                    <div class="feed-week">

                        <!-- Looping throught every events -->
                        @foreach (var item in week.events) {
                            var today = "";
                            if (item.StartDateTime.Date.Equals(DateTime.Now.Date)) {
                                today = "today";
                            }

                            <!-- Link on every event -->
                            <div class="feed-container @today" id="feed-@item.ID">

                                <!-- Container for the event content -->
                                <div class="content">

                                    <!-- Container for the top row -->
                                    <div class="class-info event-id-@item.ID" data-toggle="modal" data-target="#@item.ID">
                                        <div class="class-date">
                                           
                                            <!-- 17 -->
                                            <p class="date-number">@item.StartDateTime.Day</p>  
                                        </div>

                                        <!-- tooltip hover extravaganza -->
                                        <div class="tip-item">

                                            <!-- "Grensesnittdesign" -->
                                            <p class="name activator timeleft">@item.Subject.Name</p>
                                            @{  string timeLeft = TimeLeft.GetTimeLeft(item.StartDateTime);
                                                bool lessThanAnHour = false;
                                                bool lessThan24 = false;
                                            }
                                            @if (timeLeft != "") {
                                                if (item.StartDateTime > DateTime.Now.AddHours(24)) {
                                                    <div class="tip timeleft">@timeLeft</div>
}
                                                if (item.StartDateTime < DateTime.Now.AddHours(24)) {
                                                    if (item.StartDateTime < DateTime.Now.AddHours(1)) {
                                                        lessThanAnHour = true;
                                                    }
                                                    else {
                                                        lessThan24 = true;
                                                    }
                                                }
                                            }
                                        </div>
                                        <div class="right-position">
                                            @{  var typeClass = "";
                                                var typeText = item.EventTypeLabel;

                                                if (item.MainEventType == TikTokCalendar.Models.MainEventType.Innlevering) {
                                                    typeClass = "assignment";
                                                    //typeText = "Innlevering";
                                                }
                                                else if (item.MainEventType == TikTokCalendar.Models.MainEventType.Eksamen) {
                                                    typeClass = "exam";
                                                    //typeText = "Eksamen";
                                                }
                                            }

                                            <p class="@typeClass">@typeText</p> <!-- "Forelesning" -->
                                            <p class="room">@item.RoomName</p>  <!-- "Rom 41" -->
                                        </div>
                                    </div>

                                    <!-- Container for bottom row -->
                                    <div class="time-info">
                                        <div class="left-position" data-toggle="modal" data-target="#@item.ID">
                                            <!-- Date and time  -->
                                            <p class="time">
                                                <strong>&nbsp;@item.GetDayOfWeek()</strong>@item.GetTimeSlot()
                                                @if (DateTime.Now > item.StartDateTime && DateTime.Now < item.EndDateTime) {
                                                    <b>&nbsp;&nbsp;&nbsp;</b><span class="on ">Pågår</span>
}
                                                else if (lessThanAnHour) {

                                                    <!-- real time countdown script -->
                                                    <script>
                                                        $(function () {
                                                            var date = new Date();
                                                            date = new Date(@item.StartDateTime.Year , @item.StartDateTime.AddMonths(-1).Month , @item.StartDateTime.Day , @item.StartDateTime.Hour , @item.StartDateTime.Minute , @item.StartDateTime.Second );
                                                            $('.countdown-@item.ID').countdown({until: date, expiryUrl: ''+window.location.href, compact: true,
                                                                layout: '&nbsp;{hnn}{sep}{mnn}{sep}{snn}' });
                                                        });
                                                    </script>
                                                    <span>&nbsp;|</span>
                                                <span class="countdown-@item.ID"></span>
}
                                                else if (lessThan24) {
                                                    <b>&nbsp;&nbsp;&nbsp;</b><span class="countdown">@timeLeft</span>
}
                                            </p>
                                        </div>

                                        <!-- Icon displaying "..."  -->
                                        
										<!-- FLYTT GOING/ATTEND KODEBLOKK NED HIT NÅR EVENT-CLICK ER FIKSA -->
                                        <!-- eventually limit the number of weeks for going/check-in to show here:
                                        if (DateTime.Now > item.StartDateTime && DateTime.Now < item.EndDateTime.AddDays(21))
                                        {-->
                                        @if (userName != "" && userName != "Jon Doe" && item.MainEventType != TikTokCalendar.Models.MainEventType.Innlevering) {
                                            using (Ajax.BeginForm("UserStatUpdate","Home",new AjaxOptions {
                                                HttpMethod = "POST",
                                                UpdateTargetId = "going-" + item.ID,
                                                InsertionMode = InsertionMode.Replace
                                            })) {
                                                // Everything in this div is replaced by content in _UserStatUpdate.cshtml on button press
                                        <div class="check-in" id="going-@item.ID">
                                            @if (DateTime.Now > item.StartDateTime && DateTime.Now < item.EndDateTime) {
                                                bool geo = true;
                                                if (!EUSH.UserAttending(item.ID,userName)) {
													<input type="hidden" name="eventid" value="@item.ID" />
													<input type="hidden" name="attend" value="true" />
													<input type="submit" value="Check-in" />
}
                                                else {
													<strong>Innsjekket &#10004;</strong>
}

                                            }
                                            else {
                                                if (!EUSH.UserGoing(item.ID)) {
                                                    <input type="hidden" name="eventid" value="@item.ID" />
                                                    <input type="hidden" name="attend" value="false" />
                                                    <input type="submit" value="Going" class="going-@item.ID"/>
}
                                                else {
                                                    <strong>Du skal.</strong>
}
                                            }
                                            <div class="tip-item">
                                                @{  var howMany = EUSH.HowManyUsersGoing(item.ID);
                                                    var showTip = "hide";
                                                    if (howMany > 0) {
                                                        showTip = ""; // false (hide box if no users to display)
                                                    }
                                                }
                                                <span class="activator usersgoing event-id-@item.ID">@howMany going</span>
                                                <div class="tip usersgoing @showTip">
                                                    @foreach (var eus in Model.eventUserStats) {
                                                        if (eus.EventID == item.ID) {
                                                            <span class="no-linebreak">
                                                                @if (EUSH.UserAttending(item.ID,eus.UserName)) {
                                                                    <text>&#10004;</text>
}
                                                                @eus.UserName<br />
                                                            </span>
}
                                                    }
                                                </div>
                                            </div>
                                        </div>   }
                                                    }
                                    </div>
                                </div>
                            </div>

								<!-- "More info" modal -->
                                <div class="content-hidden modal fade" id="@item.ID" role="dialog">
                                    <div class="modal-dialog">
                                        <div class="modal-content">

                                            <!-- Modal header -->
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                @item.Subject.Name
                                            </div>

                                            <!-- Modal body -->
                                            <div class="modal-body">
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Tid</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.GetDayOfWeek()@item.GetTimeSlot()
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Uke</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @week.WeekNumber
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Rom</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.RoomName
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Lærer</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.Teacher
                                                    </span>
                                                </div>
                                                <div class="info-rows">
                                                    <span class="modal-left">
                                                        <strong>Kommentar</strong>
                                                    </span>
                                                    <span class="modal-right">
                                                        @item.Comment
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
							}
					</div>
				}
			</div>
        }
		
		<!-- Ledige rom modal -->
		<div class="content-hidden modal fade" id="vis-rom-modal" role="dialog">
			<div class="modal-dialog" style="width: 900px; max-width: 100%; margin-top: 160px;">
				<div class="modal-content">

					<!-- Modal header -->
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						Ledige rom
					</div>

					<!-- Modal body -->
					<div class="modal-body" style="margin: 0;">
						<table id="" class="table table-bordered table-hover rooms-available">
							<tr>
								<th>Rom</th>
								<td>
									<div class="progress">
										<div class="progress-bar" role="progressbar" style="width:10%">8:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">9:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">10:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">11:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">12:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">13:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">14:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">15:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">16:15</div>
										<div class="progress-bar" role="progressbar" style="width:10%">17:15</div>
									</div>
								</td>
							</tr>
							<tr>
								<th>Vrimle</th>
								<td>
									<div class="progress">
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:10%">8:15</div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%">9:15</div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:10%">10:15</div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%">11:15</div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:10%">12:15</div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%">13:15</div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:10%">14:15</div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%">15:15</div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:10%">14:15</div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%">15:15</div>
									</div>
								</td>
							</tr>
							<tr>
								<th>Auditoriet</th>
								<td>
									<div class="progress">
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:40%">8:15-12:00</div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%">12:15-13:00</div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:30%">13:15-16:00</div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%">16:15-17:00</div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:10%">17:15-18:00</div>
									</div>
								</td>
							</tr>
							<tr>
								<th>Rom 79-80</th>
								<td>
									<div class="progress">
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:20%"></div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:20%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:20%"></div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:20%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:20%"></div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:20%"></div>
									</div>
								</td>
							</tr>
							<tr>
								<th>Rom 83</th>
								<td>
									<div class="progress">
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:70%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%"></div>
									</div>
								</td>
							</tr>
							<tr>
								<th>Rom 40</th>
								<td>
									<div class="progress">
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:40%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%"></div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:20%"></div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:30%"></div>
									</div>
								</td>
							</tr>
							<tr>
								<th>Rom 41</th>
								<td>
									<div class="progress">
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:40%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%"></div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:30%"></div>
										<div class="progress-bar progress-bar-success" role="progressbar" style="width:10%"></div>
										<div class="progress-bar progress-bar-danger" role="progressbar" style="width:10%"></div>
									</div>
								</td>
							</tr>
						</table>
					</div>
				</div>
			</div>
		</div>



		<!-- Log in window modal -->
		<div class="content-hidden modal fade" id="login-modal" role="dialog">
			<div class="modal-dialog">
				<div class="modal-content">

					<!-- Modal header -->
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						Logg inn
					</div>

					<!-- Modal body -->
					<div class="modal-body">
						@using (Html.BeginForm("Index","Home")) {
							<input type="text" class="form-control" id="email" name ="Email" placeholder="Brukernavn">
							<input type="password" class="form-control" id="pwd" name ="Password" placeholder="Passord">

							<button type="submit" class="btn btn-md btn-primary btn-block btn-login">logg inn</button>
                        }
						<span data-toggle="modal" data-target="#login-modal">
							<a class="btn btn-md btn-default btn-block btn-free-rooms" data-toggle="modal" data-target="#vis-rom-modal">vis ledige rom</a>
						</span>
					</div>
				</div>
			</div>
		</div>

		@{
			TikTokCalendar.DAL.Cookies show = new TikTokCalendar.DAL.Cookies();
			bool hasShownCookieWarning = show.LoadHasShownFromCookie();
			if (!hasShownCookieWarning) {
				<div class="jumbotron" id="cookie-warning">
					<button type="button" class="close" onclick="closeCookieWarning()">&times;</button>
						<p>
						<strong>Informasjonskapsler</strong><br />
						Denne nettsiden bruker <em>informasjonskapsler</em>. Ved å bruke siden godtar du at disse blir lagret på din maskin.
					</p>
				</div>
			}
		}

    </div>
</main>



<script>
	
    function closeCookieWarning() {
    	$("#cookie-warning").hide();
        @{  
            show.SaveHasShownToCookie();
        }
    }

</script>